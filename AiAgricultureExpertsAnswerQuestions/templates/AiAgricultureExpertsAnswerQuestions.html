{% extends "template.html" %}

{% block title %}
    AIæ™ºæ…§é—®ç­”
{% endblock %}

{% block extra_css %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .AI_main-box {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .AI_container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            height: 100vh;
        }

        #AI_user-input {
            flex: 1;
            margin-left: 0px;
        }

        #AI_send-btn {
            margin-left: 10px;
        }

        /* æ ·å¼å®¹å™¨ */
        .AI_chat-container {
            overflow-y: auto;
            width: 1370px;
            max-width: 100%;
            max-height: 650px;
            padding: 35px;
            border: 1px solid #ccc;
            border-radius: 15px;
            background: linear-gradient(135deg, #f8fdff 0%, #e6f7ff 100%);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 3px solid #022244;
            flex: 1;
            word-wrap: break-word;
        }

        /* å¯¹è¯å®¹å™¨ */
        .message-AI_container {
            display: flex;
            flex-direction: row;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ç”¨æˆ·æ¶ˆæ¯æ ·å¼ */
        .AI_user-message {
            margin-left: auto;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 12px 18px;
            border-radius: 18px;
            border-bottom-right-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            max-width: 70%;
        }

        /* æœºå™¨äººæ¶ˆæ¯æ ·å¼ */
        .AI_bot-message {
            margin-right: auto;
            background: white;
            color: #333;
            padding: 12px 18px;
            border-radius: 18px;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            max-width: 70%;
            line-height: 1.5;
            position: relative;
        }

        /* æ‰“å­—æœºå…‰æ ‡ */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #4CAF50;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        @keyframes blink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0;
            }
        }

        /* å¤´åƒæ ·å¼ */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .user-avatar {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .bot-avatar {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }

        /* è¾“å…¥å®¹å™¨æ ·å¼ */
        .input-AI_container {
            margin-top: 15px;
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        .input-AI_container input[type="text"] {
            flex: 1;
            margin-left: 3%;
            width: 950px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-AI_container input[type="text"]:focus {
            border-color: #022244;
            box-shadow: 0 0 0 2px rgba(2, 34, 68, 0.1);
            outline: none;
        }

        /* å‘é€æŒ‰é’®æ ·å¼ */
        .input-AI_container button {
            margin-left: 1%;
            padding: 15px 20px;
            background: linear-gradient(135deg, #022244 0%, #034078 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 100px;
        }

        .input-AI_container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .input-AI_container button:active {
            transform: translateY(0);
        }

        /* è¯­éŸ³æ§åˆ¶æŒ‰é’® */
        #voice-toggle {
            margin-left: 10px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 130px;
        }

        #voice-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .AI_header {
            justify-content: center;
            align-items: center;
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 40px;
            max-width: 100%;
            border: 2px solid #022244;
            background: linear-gradient(135deg, #021c37 0%, #034078 100%);
            text-align: center;
            line-height: 40px;
            font-size: 55px;
            font-weight: 1000;
            color: white;
            letter-spacing: 60px;
            z-index: 999;
        }

        /* æ›´æ–°å¼¹æ¡†æ ·å¼ */
        .alert-box {
            position: fixed;
            color: white;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border-radius: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            transition: top 0.5s ease;
            font-weight: bold;
        }

        .show {
            top: 100px;
        }
    </style>
{% endblock %}

{% block main_body %}
    <div id="AI_body">
        <div class="AI_container">
            <div class="AI_main-box">
                <div class="AI_chat-container" id="chat-window"></div>

                <div id="AI_chat-container" class="input-AI_container">
                    <input type="text" id="AI_user-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...">
                    <button id="AI_send-btn">å‘é€</button>
                    <button id="voice-toggle">ğŸ”Š è¯­éŸ³æœ—è¯»</button>
                </div>

            </div>

        </div>

        {% csrf_token %}
        <script>
            window.onload = function () {
                var welcome = $('<div class="message-AI_container"></div>');
                var botAvatar = $('<div class="avatar bot-avatar">æˆ</div>');
                var botMessage = $('<div class="AI_bot-message"></div>').text("æ¬¢è¿ä½¿ç”¨AIå†œä¸šä¸“å®¶æ™ºæ…§é—®ç­”ï¼Œæ‚¨çš„ä¸“å±AIåŠ©æ‰‹å°æˆè§£ç­”æ‚¨é‡åˆ°çš„ä»»ä½•é—®é¢˜å’Œç–‘æƒ‘ï¼Œå¿«æ¥è¯•è¯•å­ï¼");

                welcome.append(botAvatar);
                welcome.append(botMessage);
                $('#chat-window').append(welcome);
                scrollToBottom();
            }

            var csrfToken = "{{ csrf_token }}";
            var voiceEnabled = true;
            var currentTyping = null;
            var currentUtterance = null;

            // æ‰“å­—æœºæ•ˆæœå‡½æ•°
            function typewriterEffect(element, text, onComplete) {
                // æ¸…é™¤ä»»ä½•æ­£åœ¨è¿›è¡Œçš„æ‰“å­—æ•ˆæœ
                if (currentTyping) {
                    clearTimeout(currentTyping);
                }

                // è®¾ç½®è¯­éŸ³å‚æ•° - ç¨å¾®å¿«ä¸€ç‚¹
                if (voiceEnabled) {
                    speakText(text, element);
                }

                // å¼€å§‹æ‰“å­—æ•ˆæœ
                var i = 0;
                element.text(''); // æ¸…ç©ºå…ƒç´ å†…å®¹

                function type() {
                    if (i < text.length) {
                        element.append(text.charAt(i));
                        i++;
                        currentTyping = setTimeout(type, 50); // è°ƒæ•´æ‰“å­—é€Ÿåº¦
                    } else if (onComplete) {
                        onComplete();
                    }
                }

                type();
            }

            // è¯­éŸ³åˆæˆå‡½æ•° - ä¿®æ”¹ä¸ºä¸æ‰“å­—æœºæ•ˆæœåŒæ­¥
            function speakText(text, element) {
                if ('speechSynthesis' in window) {
                    // åœæ­¢å½“å‰æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
                    window.speechSynthesis.cancel();

                    // åˆ›å»ºæ–°çš„è¯­éŸ³å®ä¾‹
                    currentUtterance = new SpeechSynthesisUtterance(text);

                    // è®¾ç½®è¯­éŸ³å‚æ•° - ç¨å¾®å¿«ä¸€ç‚¹
                    currentUtterance.rate = 1.2;    // å¢åŠ è¯­é€Ÿ
                    currentUtterance.pitch = 1.0;
                    currentUtterance.volume = 1.0;
                    currentUtterance.lang = 'zh-CN';

                    // å¯é€‰ï¼šé€‰æ‹©è¯­éŸ³ï¼ˆå¦‚æœæœ‰å¤šä¸ªè¯­éŸ³å¯ç”¨ï¼‰
                    var voices = speechSynthesis.getVoices();
                    var chineseVoice = voices.find(voice => voice.lang.includes('zh') || voice.lang.includes('CN'));
                    if (chineseVoice) {
                        currentUtterance.voice = chineseVoice;
                    }

                    // æ’­æ”¾è¯­éŸ³
                    window.speechSynthesis.speak(currentUtterance);

                    // è¯­éŸ³å¼€å§‹æ’­æ”¾æ—¶æ·»åŠ å…‰æ ‡
                    currentUtterance.onstart = function () {
                        element.append('<span class="typing-cursor"></span>');
                    };

                    // è¯­éŸ³ç»“æŸæ—¶ç§»é™¤å…‰æ ‡
                    currentUtterance.onend = function () {
                        $('.typing-cursor').remove();
                        console.log('è¯­éŸ³æ’­æ”¾ç»“æŸ');
                    };

                    currentUtterance.onerror = function (event) {
                        console.error('è¯­éŸ³æ’­æ”¾é”™è¯¯:', event);
                        $('.typing-cursor').remove();
                    };

                } else {
                    console.warn('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½');
                }
            }

            // åœæ­¢è¯­éŸ³å‡½æ•°
            function stopSpeaking() {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    $('.typing-cursor').remove();
                }
            }

            $(document).ready(function () {
                // è¯­éŸ³æ§åˆ¶æŒ‰é’®äº‹ä»¶å¤„ç†
                $('#voice-toggle').click(function () {
                    voiceEnabled = !voiceEnabled;
                    if (voiceEnabled) {
                        $(this).text('ğŸ”Š è¯­éŸ³æœ—è¯»').css('background', 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)');
                    } else {
                        stopSpeaking();
                        $(this).text('ğŸ”‡ è¯­éŸ³å…³é—­').css('background', 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)');
                    }
                });

                $('#AI_send-btn').click(function () {
                    var userInput = $('#AI_user-input').val();
                    if (userInput.trim() === '') {
                        return;
                    }
                    sendMessage();
                    alertBox();
                });

                $('#AI_user-input').keypress(function (event) {
                    var userInput = $('#AI_user-input').val();
                    if (userInput.trim() === '') {
                        return;
                    }
                    if (event.keyCode === 13) {
                        sendMessage();
                        alertBox();
                    }
                });

                function sendMessage() {
                    var userInput = $('#AI_user-input').val();
                    if (userInput.trim() === '') {
                        return;
                    }

                    // åœæ­¢å½“å‰æ­£åœ¨è¿›è¡Œçš„æ‰“å­—å’Œè¯­éŸ³
                    if (currentTyping) {
                        clearTimeout(currentTyping);
                    }
                    stopSpeaking();

                    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
                    var userMessageContainer = $('<div class="message-AI_container"></div>');
                    var userAvatar = $('<div class="avatar user-avatar">æ‚¨</div>');
                    var userMessage = $('<div class="AI_user-message"></div>').text(userInput);

                    userMessageContainer.append(userAvatar);
                    userMessageContainer.append(userMessage);
                    $('#chat-window').append(userMessageContainer);

                    $('#AI_user-input').val('');
                    scrollToBottom();

                    $.ajax({
                        type: 'POST',
                        url: '/AiAgricultureExpertsAnswerQuestions/',
                        data: {
                            'user_input': "ä½ ä½œä¸ºèµ„æ·±å†œä¸šä¸“å®¶ï¼Œéœ€åœ¨100å­—å†…ç»™å‡ºä¸“ä¸šã€ç²¾å‡†ã€å®ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚è¦æ±‚ç›´å‡»é—®é¢˜æœ¬è´¨ï¼Œè¯­è¨€ç²¾ç‚¼ã€‚æ³¨æ„ä½ åªèƒ½è®¤çœŸå›ç­”å†œä¸šç›¸å…³é—®é¢˜" + userInput,
                            'csrfmiddlewaretoken': csrfToken
                        },
                        dataType: 'json',
                        success: function (data) {
                            var answer = data.answer;

                            // æ˜¾ç¤ºAIå›å¤æ¶ˆæ¯
                            var botMessageContainer = $('<div class="message-AI_container"></div>');
                            var botAvatar = $('<div class="avatar bot-avatar">æˆ</div>');
                            var botMessageElement = $('<div class="AI_bot-message"></div>');

                            botMessageContainer.append(botAvatar);
                            botMessageContainer.append(botMessageElement);
                            $('#chat-window').append(botMessageContainer);

                            // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºå›å¤ï¼Œå¹¶åŒæ­¥è¯­éŸ³
                            typewriterEffect(botMessageElement, answer, function () {
                                // æ‰“å­—å®Œæˆåçš„å›è°ƒ
                                scrollToBottom();
                            });

                            // åˆå§‹æ»šåŠ¨
                            scrollToBottom();
                        },
                        error: function (xhr, status, error) {
                            console.error('è¯·æ±‚å¤±è´¥:', error);
                            var errorMessageContainer = $('<div class="message-AI_container"></div>');
                            var botAvatar = $('<div class="avatar bot-avatar">ä½³ä¹</div>');
                            var errorMessage = $('<div class="AI_bot-message"></div>').text('æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');

                            errorMessageContainer.append(botAvatar);
                            errorMessageContainer.append(errorMessage);
                            $('#chat-window').append(errorMessageContainer);
                            scrollToBottom();
                        }
                    });
                }

                function scrollToBottom() {
                    var chatWindow = $('#chat-window');
                    chatWindow.scrollTop(chatWindow[0].scrollHeight);
                }
            });

            function alertBox() {
                var alertBox = document.createElement("div");
                alertBox.innerHTML = "å°æˆä¸ºæ‚¨è§£æƒ‘ä¸­ï¼Œè¯·ç¨åï¼";
                alertBox.classList.add("alert-box");

                document.body.appendChild(alertBox);
                alertBox.offsetHeight;
                alertBox.classList.add("show");

                setTimeout(function () {
                    alertBox.classList.remove("show");
                    setTimeout(function () {
                        if (document.body.contains(alertBox)) {
                            document.body.removeChild(alertBox);
                        }
                    }, 500);
                }, 3000);
            };
        </script>
    </div>
{% endblock %}

{% block extra_js %}

{% endblock %}